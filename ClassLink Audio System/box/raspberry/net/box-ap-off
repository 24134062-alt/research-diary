#!/bin/bash
###############################################
# ClassLink - T·∫Øt WiFi Access Point Mode
# 
# D·ª´ng hotspot v√† chuy·ªÉn v·ªÅ client mode
###############################################

set -e

AP_CON_NAME="ClassLink-Hotspot"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[AP-OFF]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[AP-OFF]${NC} $1"
}

log_error() {
    echo -e "${RED}[AP-OFF]${NC} $1"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    log_error "Vui l√≤ng ch·∫°y v·ªõi sudo: sudo $0"
    exit 1
fi

log_info "ƒêang t·∫Øt Access Point..."

# Deactivate hotspot
if nmcli connection show --active | grep -q "$AP_CON_NAME"; then
    log_info "D·ª´ng hotspot..."
    nmcli connection down "$AP_CON_NAME" || true
fi

# Delete the connection profile
if nmcli connection show | grep -q "$AP_CON_NAME"; then
    log_info "X√≥a c·∫•u h√¨nh hotspot..."
    nmcli connection delete "$AP_CON_NAME" || true
fi

# Re-enable WiFi scanning/autoconnect
log_info "K√≠ch ho·∫°t l·∫°i WiFi client mode..."
nmcli device set wlan0 autoconnect yes
nmcli device set wlan0 managed yes

# Try to auto-connect to any saved network
log_info "Th·ª≠ k·∫øt n·ªëi WiFi ƒë√£ l∆∞u..."
nmcli device wifi rescan 2>/dev/null || true
sleep 2
nmcli --wait 10 device connect wlan0 2>/dev/null || true

# Check status
sleep 2
CONNECTED_SSID=$(nmcli -t -f ACTIVE,SSID device wifi | grep "^yes:" | cut -d: -f2)

if [ -n "$CONNECTED_SSID" ]; then
    log_info "‚úÖ Access Point ƒë√£ t·∫Øt!"
    log_info "üì∂ ƒê√£ k·∫øt n·ªëi WiFi: $CONNECTED_SSID"
else
    log_warn "‚ö†Ô∏è Access Point ƒë√£ t·∫Øt, nh∆∞ng ch∆∞a k·∫øt n·ªëi WiFi n√†o."
    log_warn "D√πng web dashboard ho·∫∑c ch·∫°y: box-wifi-connect <SSID> <password>"
fi

exit 0
