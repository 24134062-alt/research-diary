#!/bin/bash
###############################################
# ClassLink - K·∫øt n·ªëi WiFi
# 
# Usage: box-wifi-connect <SSID> [password]
# L∆∞u connection profile ƒë·ªÉ t·ª± k·∫øt n·ªëi khi boot
###############################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[WIFI]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WIFI]${NC} $1"
}

log_error() {
    echo -e "${RED}[WIFI]${NC} $1"
}

# Parse arguments
SSID="$1"
PASSWORD="$2"

if [ -z "$SSID" ]; then
    echo "Usage: $0 <SSID> [password]"
    echo ""
    echo "Examples:"
    echo "  $0 \"MyHomeWiFi\" \"mypassword123\""
    echo "  $0 \"OpenNetwork\""
    exit 1
fi

log_info "ƒêang k·∫øt n·ªëi ƒë·∫øn: $SSID"

# Check if running as root (recommended for connection changes)
if [ "$EUID" -ne 0 ]; then
    log_warn "Khuy·∫øn ngh·ªã ch·∫°y v·ªõi sudo ƒë·ªÉ l∆∞u c·∫•u h√¨nh"
fi

# First, turn off AP mode if it's active
AP_CON_NAME="ClassLink-Hotspot"
if nmcli connection show --active | grep -q "$AP_CON_NAME"; then
    log_info "T·∫Øt Access Point mode tr∆∞·ªõc..."
    nmcli connection down "$AP_CON_NAME" 2>/dev/null || true
    nmcli connection delete "$AP_CON_NAME" 2>/dev/null || true
    sleep 2
fi

# Trigger a fresh WiFi scan
log_info "Qu√©t WiFi..."
nmcli device wifi rescan 2>/dev/null || true
sleep 2

# Build connection command
CMD="nmcli --wait 30 device wifi connect \"$SSID\""
if [ -n "$PASSWORD" ]; then
    CMD="$CMD password \"$PASSWORD\""
fi

# Attempt connection
log_info "ƒêang k·∫øt n·ªëi..."
if eval $CMD; then
    # Verify connection
    sleep 3
    CONNECTED=$(nmcli -t -f ACTIVE,SSID device wifi | grep "^yes:" | cut -d: -f2)
    
    if [ "$CONNECTED" = "$SSID" ]; then
        # Get IP address
        IP_ADDR=$(ip -4 addr show wlan0 | grep -oP '(?<=inet\s)\d+\.\d+\.\d+\.\d+' | head -1)
        
        log_info "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!"
        log_info ""
        log_info "üì∂ Th√¥ng tin k·∫øt n·ªëi:"
        log_info "   SSID: $SSID"
        log_info "   IP: ${IP_ADDR:-ƒëang l·∫•y...}"
        log_info ""
        log_info "üíæ M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c l∆∞u. Raspberry Pi s·∫Ω t·ª± k·∫øt n·ªëi"
        log_info "   khi kh·ªüi ƒë·ªông l·∫°i."
        
        # Test internet connectivity
        if ping -c 1 -W 3 8.8.8.8 &>/dev/null; then
            log_info "üåê Internet: OK"
        else
            log_warn "‚ö†Ô∏è Internet: Kh√¥ng c√≥ k·∫øt n·ªëi ra ngo√†i"
        fi
        
        exit 0
    else
        log_error "‚ùå K·∫øt n·ªëi nh∆∞ng SSID kh√¥ng kh·ªõp: $CONNECTED"
        exit 1
    fi
else
    log_error "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn $SSID"
    log_error ""
    log_error "Nguy√™n nh√¢n c√≥ th·ªÉ:"
    log_error "  - M·∫≠t kh·∫©u sai"
    log_error "  - WiFi ngo√†i t·∫ßm ph·ªß s√≥ng"
    log_error "  - SSID kh√¥ng t·ªìn t·∫°i"
    log_error ""
    log_error "Th·ª≠ qu√©t l·∫°i WiFi: box-wifi-scan"
    exit 1
fi
