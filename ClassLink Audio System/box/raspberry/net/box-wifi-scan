#!/bin/bash
###############################################
# ClassLink - Quét WiFi Networks
# 
# Output: JSON format cho API sử dụng
# Usage: box-wifi-scan [--json]
###############################################

JSON_OUTPUT=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        *)
            shift
            ;;
    esac
done

# Colors (only for non-JSON output)
if [ "$JSON_OUTPUT" = false ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    CYAN='\033[0;36m'
    NC='\033[0m'
fi

log_info() {
    if [ "$JSON_OUTPUT" = false ]; then
        echo -e "${GREEN}[SCAN]${NC} $1"
    fi
}

log_error() {
    if [ "$JSON_OUTPUT" = false ]; then
        echo -e "${RED}[SCAN]${NC} $1" >&2
    else
        echo "{\"error\": \"$1\"}"
    fi
}

# Check if nmcli is available
if ! command -v nmcli &> /dev/null; then
    log_error "nmcli không được cài đặt"
    exit 1
fi

# Trigger a WiFi rescan (may need root)
log_info "Đang quét WiFi..."
nmcli device wifi rescan 2>/dev/null || true
sleep 2

# Get WiFi list
if [ "$JSON_OUTPUT" = true ]; then
    # JSON output for API
    echo "["
    first=true
    
    nmcli -t -f SSID,SIGNAL,SECURITY device wifi list 2>/dev/null | while IFS=: read -r ssid signal security; do
        # Skip empty SSIDs
        [ -z "$ssid" ] && continue
        
        # Escape special characters in SSID for JSON
        ssid_escaped=$(echo "$ssid" | sed 's/\\/\\\\/g; s/"/\\"/g')
        
        # Determine if secured
        if [ -n "$security" ] && [ "$security" != "--" ]; then
            secure="true"
        else
            secure="false"
        fi
        
        if [ "$first" = true ]; then
            first=false
        else
            echo ","
        fi
        
        echo -n "  {\"ssid\": \"$ssid_escaped\", \"signal\": $signal, \"secure\": $secure}"
    done
    
    echo ""
    echo "]"
else
    # Human-readable output
    echo ""
    printf "${CYAN}%-30s %8s %10s${NC}\n" "SSID" "Signal" "Security"
    echo "------------------------------------------------"
    
    nmcli -t -f SSID,SIGNAL,SECURITY device wifi list 2>/dev/null | while IFS=: read -r ssid signal security; do
        [ -z "$ssid" ] && continue
        
        # Color code signal strength
        if [ "$signal" -ge 70 ]; then
            sig_color=$GREEN
        elif [ "$signal" -ge 40 ]; then
            sig_color=$YELLOW
        else
            sig_color=$RED
        fi
        
        printf "%-30s ${sig_color}%7s%%${NC} %10s\n" "$ssid" "$signal" "${security:---}"
    done
    
    echo ""
    log_info "Quét hoàn tất!"
fi

exit 0
