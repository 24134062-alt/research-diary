#!/bin/bash
###############################################
# ClassLink - B·∫≠t WiFi Access Point Mode
# 
# S·ª≠ d·ª•ng NetworkManager ƒë·ªÉ t·∫°o WiFi hotspot
# SSID: ClassLink-Setup
# Password: classlink2024
# IP: 192.168.4.1
###############################################

set -e

# Configuration
AP_SSID="${CLASSLINK_AP_SSID:-ClassLink-Setup}"
AP_PASS="${CLASSLINK_AP_PASS:-classlink2024}"
AP_CON_NAME="ClassLink-Hotspot"
AP_IP="192.168.4.1/24"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[AP-ON]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[AP-ON]${NC} $1"
}

log_error() {
    echo -e "${RED}[AP-ON]${NC} $1"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    log_error "Vui l√≤ng ch·∫°y v·ªõi sudo: sudo $0"
    exit 1
fi

log_info "ƒêang b·∫≠t Access Point mode..."
log_info "SSID: $AP_SSID"
log_info "Password: $AP_PASS"

# Stop any existing hotspot with same name
log_info "D·ª´ng hotspot c≈© (n·∫øu c√≥)..."
nmcli connection delete "$AP_CON_NAME" 2>/dev/null || true

# Disconnect from any WiFi first
log_info "Ng·∫Øt k·∫øt n·ªëi WiFi hi·ªán t·∫°i..."
nmcli device disconnect wlan0 2>/dev/null || true

# Wait a moment for interface to be ready
sleep 1

# Create and activate hotspot
log_info "T·∫°o hotspot m·ªõi..."
nmcli connection add \
    type wifi \
    ifname wlan0 \
    con-name "$AP_CON_NAME" \
    autoconnect no \
    ssid "$AP_SSID" \
    wifi.mode ap \
    wifi.band bg \
    wifi.channel 7 \
    ipv4.method shared \
    ipv4.addresses "$AP_IP" \
    wifi-sec.key-mgmt wpa-psk \
    wifi-sec.psk "$AP_PASS"

# Activate the hotspot
log_info "K√≠ch ho·∫°t hotspot..."
nmcli connection up "$AP_CON_NAME"

# Verify
sleep 2
if nmcli connection show --active | grep -q "$AP_CON_NAME"; then
    log_info "‚úÖ Access Point ƒë√£ b·∫≠t th√†nh c√¥ng!"
    log_info ""
    log_info "üì∂ Th√¥ng tin k·∫øt n·ªëi:"
    log_info "   SSID: $AP_SSID"
    log_info "   Password: $AP_PASS"
    log_info "   IP: ${AP_IP%/*}"
    log_info ""
    log_info "üåê Truy c·∫≠p web: http://${AP_IP%/*}:8000"
    exit 0
else
    log_error "‚ùå Kh√¥ng th·ªÉ b·∫≠t Access Point!"
    log_error "Ki·ªÉm tra log: journalctl -u NetworkManager -n 50"
    exit 1
fi
